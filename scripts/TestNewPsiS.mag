// Paramters defining the prime p = f*lA^eA*lB^eB - 1
f := 1;
lA := 2;
lB := 3;
eA := 372;
eB := 239;

Border := 1076415339332851335838408278837787304900791017342367285006484190592481075231153579549080863047304729836926607724267;

// Define the prime p
p := f*lA^eA*lB^eB-1;
assert IsPrime(p: Proof:=false);

// or, explicitly...
print p eq
1035471774176930525297776823786680532142738964554907117011618967905467894068247\
8846502882896561066713624553211618840202385203911976522554393044160468771151816\
976706840078913334358399730952774926980235086850991501872665651576831;

// Prime field of order p
Fp := GF(p);
// Finite field of characteristic Border
Fborder := GF(Border);
// The quadratic extension via x^2 + 1 since p = 3 mod 4
Fp2<i> := ExtensionField<Fp,x|x^2+1>;

// E0 is the starting curve E0/Fp2: y^2=x^3+x (the A=0 Montgomery curve)
E0 := EllipticCurve([Fp2|1,0]);

A := Fp![0x000032BF2C80D529694CE39F524B8B75292D1091653280100C18773ABE6BFB95B0E3A438D05EA268EC9201220AC33862C74B3D25299E456B4D959A17919D3FDBF671C20ACEC258A0ACDDFEBF39579891AF6820CB2DFFAA3C4298B4E43A069B83] + Fp![0x00005E08FD27D73B0BB5865B137365555D8422B015AAD0AA5E55B735F4D8BCF5357BFCDA34504B1514EE53D99DD9971C440CCF0FE99E0ADAB520362F7C08D85FFD14C1469F4999A78BBB0F0AC46767D847009B3222637C2749FBD2E30E26CF8F]*i;

_<x> := PolynomialRing(Fp2);

//Randalls public key curve EA
EA := EllipticCurve(x^3 + A*x^2 + x);

print IsSupersingular(E0) and (p+1)*Random(EA) eq EA!0;

// Create points oldPsiS, newPsiS, R1, and R2
oldPsiSx := Fp![0x00000498E25668D217D4766965901D032D5BAAC4252C3DBED7FAA28EAC06E63BD2A5619DF1A5FD418E8E2C24666C34980A38D43689D2E77129BA3036E8550E0D2CB3D079A0382BA6DE2B135BA276C9FA41B3128C21019640FBA0393B91626A7A] + Fp![0x00006A93C5E7E8906EA4D39FFD163CBBD7EAB879505D8CD091B0E620EC58D2FAC5AC71212F922A89A27AD84F1EC9C03F9B608BE24B87072309D34DF1303EE92B00DB2FF553D170425B58A5A840A9A11E691568FC235427220E48B6ACA0C14FC3]*i;
oldPsiSy := Fp![0x000066CFF3CF400C9F66475AD00B96D19EBE4C72103A5D0A0983AA1C4D4D01548D12A3048C0CCD1B37C1904C878EDCF0D87DF05B0BB0730539FCE5F60912EC9BC33E8196F652914474DEEDF4998DF90D44F1278E4CD3813F0AC3994F01D14B3A] + Fp![0x00005B84696146EEF80C7452DD6B6083C8D439AC67A24C8FBF5A10BC3579B93314EE3B00583AA9AA9FE9077677F2333CDCCBC7B72DC25CEE302D74DC39CFA4F83EB0407226776A2BD2F1956B40B401C5AE5E945BF044C54E606E1CAF64C06408]*i;

oldPsiS := EA(Fp2)![oldPsiSx, oldPsiSy];

newPsiSx := Fp![0x000031CA07FB9282659D23A5D2D31619EB2B286C396611ACD82537F39C0EBE91A96A025A2DC762E45FC81DCCD748A7FDD12340A9DBA3C7942B04C2503303D65200C4C0649882B990BD061982215153B67E314CE3D32E53042A2F1274C2541E5F] + Fp![0x000044EF28FCE6657CF079BC8CCF4FA50BC7270CB599C2B0D76B2D5A0B45EA0DF269B81F96D9671C5DE1C3D38CC4787BAEEAD566D406FE43C36E09CD467FCB5950B8B384B45D101D1A7E7A5CD85526FD9115523E471F24427DBE1732F8569281]*i;
newPsiSy := Fp![0x00001C30918477079E16928762860A1BD4E9E236330169C566F1EEFEA35DC8DA2FCFEB38E28DAA4ADB12D0E959A6188BE0143C347201B70B43E4D3001A7780C7A42FA5692F10BFC2078AF4F290A9C3227BF564DA82F196DC0A6C4FCB5BF66B8D] + Fp![0x000067A523408E0EFD8866A1F5D28747070B6509359FD80A0ADBD117CAE4BF12C2F934E2413FF02235D86440468A35AF34D7FB3788BA5C37CFD521BCF6C7D046A526556C9EA687A8F6CE14D09CF257405119CD5797A023A51022CE88B35FCE98]*i;

// newPsiS := EA(Fp2)![newPsiSx, newPsiSy];

R1x := Fp![0x00000BC9207B17F228256403150857E393BC67BFE7EDBD5E14F2E232460C0991EF08DACDB41FE82C0F388A6F966D5AA7976B4C21C24D55D3EEDFA50FA0891C3BAFBD491AFA18CE9DCF96723D46E42F5FBBCFF4512EABAD4883F47F5DD1AC7756] + Fp![0x000000CA446E6FA5ABF9F4786507F1AB430A396430FE05ACF3687E822DF2EC054FEFE72DF199B27C2AE5B59F07849164B122691063F99A7693DBA728DE69A10D5EB344B575F98B3CBA06A0BAD212E8F9C720365003D9CD416E63E30B37126998]*i;
R1y := Fp![0x00006637406CB2EA0A5CBFCAC2F95EB4AC59708B63108B5D65BC3C92BCE8DFE82180FD57988C03C7FEA91F3CA19AE2D421F6FD4F3A64E8F2D37B5B3842CA0A923577CEA9414944289CCD077E5D0A8D32F0666B8FE474A7038142489952FB56B5] + Fp![0x000032528D7AF343A5DFC9A7412679A3037C9080B09DDACDC8D775D294CBA29F938A6E943A5973026EBD25B7210D8EFF8AB25A348F1FADC4C20F589A39CA4F791EBCF705EFBE972A344A204729A7EE0F65FDC966BF91366313649C116ED58163]*i;

R1 := EA(Fp2)![R1x, R1y];

R2x := Fp![0x00001373C4288FD8000478B05CFF5F50493CCE8D29F3F66CBB83AEB535E0D0282739C4CD9F78B1BD68A234909672D8DAFBCC6FC7CBD42BD7F9F1261658145C09B210806660A22A39803A52FA27D60DD2496DB9BDD24F96135C50D0B146D06526] + Fp![0x00000BA6B6A37D3DC30AE9F750662DB91418DD14105DCC7559FADBE161FB8CC65F9181B92EEACAA687C9343879C5621AD34B0EB7D7492BFE1A0C97911B282FACD3D4789A8DF5AB1D00923FB734251578BBDD64E53414E718FF923ADDDA358573]*i;
R2y := Fp![0x00001CB235075FA5635C2CEDE7CD53ADE60D588B121C1E90409BCFDB49DB90DDB13427992DC378745549506212475487BB17958077A6F6603FE5FBAB4C15A0EE4162DA2B7C101B6968B27A77E2D4D851A41633BC12BF54E3E068335EB1F8F2D2] + Fp![0x00004112CFE52B3E1979E2EB39410EDC991A98504EC380DAB3834C7B0224F7D5152F452F5063F8450502A5BF88EBA6E981A8A1E1FA9E1D892F39F65EC75C7E2AE441B963A4AF43732CDEE0A38ED26FBD3B13294647A7BF95674116A687848FF8]*i;

R2 := EA(Fp2)![R2x, R2y];

a := 0x03FD06931EA9ED8873C9BDC8AEABE9682A91F4605470C1E6EDADA02A650C41D65FEA9954AC95751DD7097E47315712E7;

b := 0x02ED6BA134AF72DC5A22BACAD6FC6794DC336B89B550D9451F861EFE0F531036F17F85C8E444C2FBBFC22C21F7C31086;

decompPsiS := a*R1 + b*R2;
print oldPsiS in EA;
//print newPsiS in EA;
print R1 in EA;
print R2 in EA;
print decompPsiS in EA;

psiSTriple := decompPsiS;
for i in [1..eB-1] do
  psiSTriple := 3*psiSTriple;
  if psiSTriple eq EA!0 then
    print "Error in new psi(S) order";
  end if;
end for;

//print decompPsiS eq newPsiS;
